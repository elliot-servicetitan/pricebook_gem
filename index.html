<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element Selection ---
        const generateBtn = document.getElementById('generate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const downloadBtn = document.getElementById('download-btn');
        const serviceNamesInput = document.getElementById('service-names');
        const tableBody = document.getElementById('results-table');
        const lineCountEl = document.getElementById('line-count');
        
        // --- State Management ---
        let tableData = [];
        const placeholderRowHTML = `<tr><td class="px-6 py-4 text-sm text-gray-400" colspan="2">Results will appear here once codes are generated.</td></tr>`;

        // --- Initial State ---
        tableBody.innerHTML = placeholderRowHTML;

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerateCodes);
        clearBtn.addEventListener('click', clearAll);
        downloadBtn.addEventListener('click', downloadCSV);
        
        // NEW: Event delegation for copy buttons
        tableBody.addEventListener('click', handleCopyClick);


        // --- Core Functions ---
        function handleGenerateCodes() {
            // UX: Add loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            // Use a short timeout to allow the UI to update before the heavy processing begins.
            setTimeout(() => {
                generateCodes();
                // Restore button state
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Codes';
            }, 50); 
        }

        function generateCodes() {
            const textInput = serviceNamesInput.value;
            const lines = textInput.split('\n').filter(line => line.trim() !== '');
            
            tableData = [];
            const generatedCodes = new Map();

            if (lines.length === 0) {
                lineCountEl.textContent = 'No lines detected. Please paste your data.';
                tableBody.innerHTML = placeholderRowHTML;
                downloadBtn.disabled = true;
                return;
            }
            
            // PERFORMANCE: Build HTML string instead of multiple DOM manipulations
            let tableHTML = '';

            lines.forEach(line => {
                const serviceName = line.trim();
                let code = createAcronym(serviceName);
                const originalCode = code;

                // Handle collisions
                let count = 1;
                while (generatedCodes.has(code)) {
                    count++;
                    const availableLength = 8 - String(count).length;
                    code = originalCode.substring(0, availableLength) + count;
                }
                generatedCodes.set(code, serviceName);

                tableData.push({ service: serviceName, code: code });
                
                // Append row HTML to the string
                tableHTML += `
                    <tr class="group hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-700">${serviceName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            <div class="flex items-center justify-between">
                                <span class="code-value">${code}</span>
                                <button class="copy-btn" title="Copy code">Copy</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            lineCountEl.textContent = `Successfully processed ${lines.length} lines.`;
            downloadBtn.disabled = false;
        }

        function createAcronym(text) {
            const cleanedText = text.trim().replace(/[^a-zA-Z0-9\s]/g, '');
            if (!cleanedText) return 'CODE';

            const words = cleanedText.split(/\s+/).filter(w => w);
            let acronym = '';

            words.forEach(word => {
                acronym += !isNaN(word) ? word : word[0].toUpperCase();
            });
            
            // Handle acronyms that are too short
            if (acronym.length < 2) {
                const cleanNoSpaces = cleanedText.replace(/\s/g, '');
                acronym = (cleanNoSpaces.length >= 2)
                    ? cleanNoSpaces.substring(0, 2).toUpperCase()
                    : (cleanNoSpaces.toUpperCase() + "XX").substring(0, 2);
            }
            
            // Truncate long acronyms
            return acronym.substring(0, 8);
        }
        
        function clearAll() {
            serviceNamesInput.value = '';
            tableBody.innerHTML = placeholderRowHTML;
            lineCountEl.textContent = '';
            downloadBtn.disabled = true;
            tableData = [];
        }
        
        // NEW: Copy to clipboard handler
        function handleCopyClick(event) {
            const target = event.target;
            if (target.classList.contains('copy-btn')) {
                const codeToCopy = target.parentElement.querySelector('.code-value').textContent;
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    target.textContent = 'Copied!';
                    target.classList.add('copied');
                    setTimeout(() => {
                        target.textContent = 'Copy';
                        target.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    target.textContent = 'Error';
                });
            }
        }

        /**
         * FIXED: Uses a Blob to support large datasets, avoiding URL length limits.
         */
        function downloadCSV() {
            if (tableData.length === 0) {
                lineCountEl.textContent = "Cannot download. Please generate codes first.";
                lineCountEl.classList.add('text-red-500', 'font-semibold');
                setTimeout(() => {
                    lineCountEl.textContent = lineCountEl.textContent.replace("Cannot download. Please generate codes first.", "");
                    lineCountEl.classList.remove('text-red-500', 'font-semibold');
                }, 3000);
                return;
            }

            // 1. Build the CSV content string
            let csvContent = "Service Name,Code\r\n"; // Headers
            tableData.forEach(row => {
                const service = `"${row.service.replace(/"/g, '""')}"`; // Handle quotes
                const code = `"${row.code}"`;
                csvContent += [service, code].join(',') + "\r\n";
            });

            // 2. Create a Blob from the CSV string
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // 3. Create a link and use createObjectURL to point to the Blob
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob); // Create a URL for the Blob
            link.setAttribute("href", url);
            link.setAttribute("download", "service_codes.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            
            // 4. Trigger the download and clean up
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Release the object URL
        }
    });
</script>
